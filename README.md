# README

This README would normally document whatever steps are necessary to get the
application up and running.

# РАЗВЕРТЫВАНИЕ САЙТА

Выполните последовательно команды в консоли, находясь в директории, в которой вы хотите развернуть проект.
Описание для среды, развернутой по инструкции https://gorails.com/setup/windows/10






# СТРУКТУРА САЙТА
Публичка:
/ - корень сайта
/news - публичная страница новостей, просто список новостей без пагинации. Можно перейти на деталку, кликнул по заголовку новости.
Ссылка на "Новости" размещена в главном меню сайта.

Для зарегистрированных пользователей:
/admin/profile - редактирование пользователем своих данных, по сути доступно только имя и настройка рассылки дайджеста.
Ссылка на "Профиль" доступна в выпадающем меню Аккаунта после авторизации пользователя.

Для редакторов:
/admin/news - страница для редакторов, позволяет добавлять, редактировать и удалять новостей. Осуществляется проверка прав доступа
Ссылка на "Новости" доступна в выпадающем меню Аккаунта после авторизации пользователя, отображается только у редакторов.

Для админов:
/admin/users - страница для админов, позволяет редактировать (в том числе назначать админами и редакторами) и удалять пользователей. Осуществляется проверка прав доступа. Также админы имеют доступ к редактированию новостей.
Ссылка на "Пользователи" доступна в выпадающем меню Аккаунта после авторизации пользователя, отображается только у админов.

# ЧТО СДЕЛАНО

## Реализация админского и редакторского типа записей.
Реализовал просто через поля admin и editor типа boolean. Были мысли использовать для реализации гем rolify и cancan, но в рамках постановки задачи булевых полей достаточно.

## Авторизация и регистрация с помощью гема Devise
Для кастомизации верстки view вынесены из гема в /app/views. Также с целью добавления дополнительных полей в форму регистрации соответствующий контроллер регистрации вынесен из Devise в app/controllers/users/registrations_controller.rb. 
Для этого контроллера скопированы из папки devise необходимые views.

## Страница "Нет доступа"
В папке public создана страница forbid.html для отображения пользователям, когда они пытаются получить доступ к странице, к которой у них нет доступа.

## Модель News
Поля title:string{255}, content:text, user_id:integer, last_editor_id:integer, edits_number:integer. Задана валидация полей title и content. Поле edits_number хранит количество редактирований. С помощью обработчика для before_save инкрементирует значение поля edits_number, а также контроллируем, что не превышено ограничение, иначе выдаем сообщение об ошибке.
Связана с моделью User отношением "многие-к-одному" по полю user_id


## Публичная страница новостей, контроллер news
/news - доступен просмотр списка новостей и деталки новостей. В routes.rb для контроллера News разрешены только вышеуказанные actions, чтобы исключить несанкционированное создание или редактирование новостей.

## Страница "Новости" для редакторов, контроллер admin/news
/admin/news
Реализована с помощью контроллера News, который размещен в модуле Admin. Было бы логичнее разместить в модуле Editor, но я уже поместил в Admin. Размещение в модуле позволило: 
1) сформировать урл /admin/users (что в принципе можно было достигнуть используя namespace)
2) использовать контроллер с именем, который уже используется в проекте.
Ограничение доступа реализовано с помощью обработчика для before_action, который проверяет у пользователя current_user.editor?


Использует ту же модель News, которую и публичный контроллер News

## Модель User
Поля email:string, password, name:string{255}, editor:boolean, admin:boolean, digest:enum[nodigest,weekly,dayly]. Задана валидация полей email, name. Перед сохранением задаем поле digest=weekly

## Страница "Профиль"
/profile
Реализована с помощью контроллера Users, который используется только для этой цели - отображение страницы edit и действия update. Защита от несанкционированного доступа реализована посредством ограничений доступных экшнов в routing только edit и update.
Также в контроллере для before_action назначен обработчик, который назначает переменной @user текущего пользователя. Это необходимо, так как ссылка на профиль не предполагает передачи ID пользователя, так как для профиля это лишнее, кроме этого исключает возможность передачи параметров для изменения другого пользователя.
Если на Профиль перейдет неавторизованный пользователь, то он увидит страницу с сообщением об отстутсвии доступа к страницею.
Использует вышеуказанную модуль User


## Страница "Пользователи" для админов
/admin/users
Реализована с помощью контроллера Users, который размещен в модуле Admin.
Ограничение доступа реализовано с помощью обработчика для before_action, который проверяет у пользователя current_user.admin?
Использует вышеуказанную модуль User

## Рассылка дайджеста
Для еженедельной и ежедневной рассылок сгенерены соответствующие Mailer, а для них Job. Чтобы выполнять рассылку в заданное время установлены resque и resque-scheduler. В файле config/rescue_scheduler.yml прописаны задачи. По идее job должны запускаться по расписанию, но, к сожалению, сходу завести не удалось. При запуске rescue пишет, что задача запущена, но логирование показывает, что не вызывается метод perform у Job и при этом не выдает никакой ошибки. Пытался удалить сам метод perform и даже наследование, чтобы исключить вызов наследуемого метода, но ошибок не пишет. Я пока не стал дальше отлаживать.


## Функциональное тестирование
Контроллеры геренировались командой rails scaffold_controller, поэтому тесты для контроллеров, в принципе, были готовы. Но после внесенных мной изменений в контроллеры тесты выдавали около 15 ошибок, которые я отладил.

## Интеграционное тестирование
Написал интеграционный тест для тестирования функционала новостей для редакторов. Тест включает в себя проверку всего цикла - создание, редактирование и удаление.




Things you may want to cover:

* Ruby version

* System dependencies

* Configuration

* Database creation

* Database initialization

* How to run the test suite

* Services (job queues, cache servers, search engines, etc.)

* Deployment instructions

* ...
